name: CI

on:
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - '.mise.toml'
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '24'

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Optimized for GitHub Enterprise COGS:
# - CI only runs on PRs (deploy workflow handles main, trusts PR checks)
# - Path filters skip CI for docs-only changes
# - Concurrency cancels superseded runs
# - Single job combines lint, test, and build to reduce runner overhead
# - Single Node.js version (production target) instead of matrix
# - No artifact uploads (deploy workflow builds fresh)

jobs:
  ci:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Lint code
      run: yarn lint

    - name: Check formatting
      run: yarn format:check

    - name: Run tests
      run: yarn test

    - name: Build project
      run: yarn build

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
