name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allow the workflow to be manually triggered via the GitHub UI
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '24'

# Optimized for GitHub Enterprise COGS:
# - Single job combines lint, test, and build to reduce runner overhead
# - Single Node.js version (production target) instead of matrix
# - No artifact uploads (deploy workflow builds fresh)
# - Dependency review only on PRs

jobs:
  ci:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Lint code
      run: yarn lint

    - name: Check formatting
      run: yarn format:check

    - name: Run tests
      run: yarn test

    - name: Build project
      run: yarn build

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
