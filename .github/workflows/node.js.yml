name: CI

on:
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - '.mise.toml'
      - 'migrations/**'
  workflow_dispatch:

permissions:
  contents: read

env:
  NODE_VERSION: '24'

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

# COGS optimizations:
# - Single job (dependency-review merged) saves runner startup overhead
# - Path filters skip CI for docs/config-only changes
# - Concurrency cancels superseded runs
# - timeout-minutes caps runaway jobs
# - Sparse checkout reduces clone time
# - yarn cache via setup-node

jobs:
  ci:
    name: Lint, Test & Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        sparse-checkout: |
          src
          __tests__
          package.json
          yarn.lock
          tsconfig.json
          jest.config.js
          eslint.config.mjs
          .prettierrc
        sparse-checkout-cone-mode: false

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile --prefer-offline

    - name: Lint and test
      run: |
        yarn lint
        yarn format:check
        yarn test

    - name: Dependency review
      uses: actions/dependency-review-action@v4
      if: github.event_name == 'pull_request'
