name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - '.mise.toml'
      - 'migrations/**'
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: '24'
  WORKER_URL: 'https://podr-service.cascadiacollections.workers.dev'

# Cancel in-progress deploys when new commits are pushed
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

# COGS optimizations:
# - Deploy only on main push (CI runs on PRs)
# - Path filters skip deploy for docs-only changes
# - Concurrency cancels superseded deploys
# - timeout-minutes caps runaway deploys
# - Sparse checkout for faster clone
# - --prefer-offline uses cached packages

jobs:
  deploy:
    name: Deploy Worker
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        sparse-checkout: |
          src
          package.json
          yarn.lock
          tsconfig.json
          wrangler.toml
        sparse-checkout-cone-mode: false

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile --prefer-offline

    - name: Deploy to Cloudflare Workers
      run: yarn wrangler deploy
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Post-deploy health check
      run: |
        sleep 3
        RESPONSE=$(curl -sf --retry 2 --retry-delay 2 --max-time 10 "${{ env.WORKER_URL }}/health" || echo "FAILED")
        if [ "$RESPONSE" = "FAILED" ]; then
          echo "::error::Health check failed - endpoint unreachable"
          exit 1
        fi
        STATUS=$(echo "$RESPONSE" | jq -r '.status')
        if [ "$STATUS" != "healthy" ]; then
          echo "::error::Health check failed - status: $STATUS"
          exit 1
        fi
        echo "::notice::Deploy successful - health check passed"
