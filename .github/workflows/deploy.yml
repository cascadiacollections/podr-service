name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - '.mise.toml'
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: '24'
  WORKER_URL: 'https://podr-service.cascadiacollections.workers.dev'

# Cancel in-progress deploys when new commits are pushed
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Worker
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'yarn'

    - name: Install dependencies
      run: yarn install --frozen-lockfile

    - name: Deploy to Cloudflare Workers
      uses: cloudflare/wrangler-action@v3
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

    - name: Post-deploy health check
      run: |
        sleep 5
        RESPONSE=$(curl -sf --retry 3 --retry-delay 2 "${{ env.WORKER_URL }}/health" || echo "FAILED")
        if [ "$RESPONSE" = "FAILED" ]; then
          echo "::error::Health check failed - endpoint unreachable"
          exit 1
        fi
        STATUS=$(echo "$RESPONSE" | jq -r '.status')
        if [ "$STATUS" != "healthy" ]; then
          echo "::error::Health check failed - status: $STATUS"
          exit 1
        fi
        echo "Health check passed"
